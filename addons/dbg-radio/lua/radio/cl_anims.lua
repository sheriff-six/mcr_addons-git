local radioAnim = {
    stand = {
		Bip01_L_Hand = { ang = Angle(0, -20, -60) },
		Bip01_L_Forearm = { ang = Angle(-5, -95, -8) },
		Bip01_L_Clavicle = { ang = Angle(0, 0, 0) },
		Bip01_L_UpperArm = { ang = Angle(-10, -30, 0) },

		Bip01_L_Finger0 = { ang = Angle(30, 0, 0) },
		Bip01_L_Finger02 = { ang = Angle(0, 0, 0) },
		Bip01_L_Finger1 = { ang = Angle(-20, -30, 0) },
		Bip01_L_Finger12 = { ang = Angle(0, 0, 0) },
		Bip01_L_Finger2 = { ang = Angle(-5, -30, 0) },
		Bip01_L_Finger21 = { ang = Angle(0, 0, 0) },
		Bip01_L_Finger22 = { ang = Angle(0, 0, 0) },
        Bip01_L_Finger3 = { ang = Angle(8, -30, 0) },
        Bip01_L_Finger4 = { ang = Angle(25, -30, 0) },

		Bip01_Head1 = { ang = Angle(0,-10,0) },

		Bip01_R_Forearm = { ang = Angle(0, 0, 0) },
		Bip01_R_Hand = { ang = Angle(0, 0, 0) },
		fov = 0.2,
	},

	sitting = {
		Bip01_L_Hand = { ang = Angle(-10, -45, -105) },
		Bip01_L_Forearm = { ang = Angle(0, -22, -60) },
		Bip01_L_Clavicle = { ang = Angle(0, 0, 0) },
		Bip01_L_UpperArm = { ang = Angle(-10, -30, 0) },

		Bip01_L_Finger0 = { ang = Angle(-15, -10, 0) },
		Bip01_L_Finger02 = { ang = Angle(0, -20, 0) },
		Bip01_L_Finger1 = { ang = Angle(20, -18, -30) },
		Bip01_L_Finger12 = { ang = Angle(0, -10, 0) },
		Bip01_L_Finger2 = { ang = Angle(15, -12, -10) },
		Bip01_L_Finger22 = { ang = Angle(0, -10, 0) },

		Bip01_Head1 = { ang = Angle(0,-10,0) },

		Bip01_R_Forearm = { ang = Angle(0, 0, 0) },
		Bip01_R_Hand = { ang = Angle(0, 0, 0) },
		fov = 0.3,
	},

	crouching = {
		Bip01_L_Hand = { ang = Angle(6, -30, -20) },
		Bip01_L_Forearm = { ang = Angle(0, 0, -40) },
		Bip01_L_Clavicle = { ang = Angle(5, 20, 0) },
		Bip01_L_UpperArm = { ang = Angle(30, -65, -5) },

		Bip01_L_Finger0 = { ang = Angle(-30, 0, 0) },
		Bip01_L_Finger02 = { ang = Angle(0, -15, 0) },
		Bip01_L_Finger1 = { ang = Angle(17, 23, 0) },
		Bip01_L_Finger12 = { ang = Angle(-10, 25, 0) },
		Bip01_L_Finger2 = { ang = Angle(15, 20, -10) },
		Bip01_L_Finger22 = { ang = Angle(0, 80, 30) },

		Bip01_Head1 = { ang = Angle(0,-10,0) },

		Bip01_R_Forearm = { ang = Angle(0, 0, 0) },
		Bip01_R_Hand = { ang = Angle(0, 0, 0) },
		fov = 0.2,
	},

	passive = {
		Bip01_L_Hand = { ang = Angle(0, 0, 80) },
		Bip01_L_Forearm = { ang = Angle(-5, -86, -8) },
		Bip01_L_Clavicle = { ang = Angle(0, 0, 0) },
		Bip01_L_UpperArm = { ang = Angle(0, 0, 0) },

		Bip01_L_Finger0 = { ang = Angle(0, 0, 0) },
		Bip01_L_Finger02 = { ang = Angle(0, 0, 0) },
		Bip01_L_Finger1 = { ang = Angle(8, 55, 0) },
		Bip01_L_Finger12 = { ang = Angle(-8, 1, 0) },
		Bip01_L_Finger2 = { ang = Angle(0, 49, 0) },
		Bip01_L_Finger21 = { ang = Angle(0, -15, 0) },
		Bip01_L_Finger22 = { ang = Angle(0, -5, -15) },

		Bip01_Head1 = { ang = Angle(0,-10,0) },

		Bip01_R_Forearm = { ang = Angle(-5, 76, 28) },
		Bip01_R_Hand = { ang = Angle(35, 0, 0) },
		fov = 0.2,
	},

	crouching_pas = {
		Bip01_L_Hand = { ang = Angle(0, 0, 80) },
		Bip01_L_Forearm = { ang = Angle(-5, -65, -8) },
		Bip01_L_Clavicle = { ang = Angle(0, 0, 0) },
		Bip01_L_UpperArm = { ang = Angle(0, 0, 0) },

		Bip01_L_Finger0 = { ang = Angle(0, 0, 0) },
		Bip01_L_Finger02 = { ang = Angle(0, 0, 0) },
		Bip01_L_Finger1 = { ang = Angle(8, 65, 0) },
		Bip01_L_Finger12 = { ang = Angle(-8, 1, 0) },
		Bip01_L_Finger2 = { ang = Angle(0, 49, 0) },
		Bip01_L_Finger21 = { ang = Angle(0, -15, 0) },
		Bip01_L_Finger22 = { ang = Angle(0, -5, -25) },

		Bip01_Head1 = { ang = Angle(0,-10,0) },

		Bip01_R_Forearm = { ang = Angle(0, 0, 0) },
		Bip01_R_Hand = { ang = Angle(0, 0, 0) },
		fov = 0.2,
	},
}

local function getProperAnim(ply)
    local veh = ply:GetVehicle()
    local weapon = ply:GetActiveWeapon()

    if IsValid(veh) then
        return radioAnim.sitting
    elseif IsValid(weapon) and ply:GetActiveWeapon():GetHoldType() == 'passive' then
        return ply:Crouching() and radioAnim.crouching_pas or radioAnim.passive
    elseif ply:Crouching() then
        return radioAnim.crouching
    elseif IsValid(weapon) and ply:GetActiveWeapon():GetHoldType() == 'normal' then
        return radioAnim.stand
    else
        return radioAnim.passive
    end
end

local function createTalkieProp(ply)
    if IsValid(ply) and not IsValid(ply.TalkieProp) then
        local hand = ply:LookupAttachment('anim_attachment_LH')

        local talkieprop = createEmpty('models/handfield_radio.mdl')
        talkieprop:SetParent(ply, hand)
        talkieprop:SetLocalPos(Vector(1.3, 0.7, 1))
        talkieprop:SetLocalAngles(Angle(-140, -15, 100))

        ply.TalkieProp = talkieprop
    end
end

local function removeTalkieProp(ply)
    if IsValid(ply) and IsValid(ply.TalkieProp) then
        ply.TalkieProp:Remove()
        ply.TalkieProp = nil
        for bone,data in pairs(getProperAnim(ply)) do
            if bone ~= 'fov' then
                local id = ply:LookupBone('ValveBiped.' .. bone)
                if not id then continue end
                if data.pos then ply:ManipulateBonePosition(id, Vector()) end
                if data.ang then ply:ManipulateBoneAngles(id, Angle()) end
            end
        end
    end
end

hook.Add('UpdateAnimation', 'radio-anims', function(ply, vel)
    ply.TalkieAnimWeight = math.Approach(
        ply.TalkieAnimWeight or 0,
        (ply:IsSpeakToRadio() and ply:OnGround()) and (1 - ply:GetVelocity():LengthSqr() / 50000) or 0,
        FrameTime() * 5
    )

    local weight = ply.TalkieAnimWeight or 0

    if weight > 0 then
        local anim = getProperAnim(ply)
        for bone, data in pairs(anim) do
			if bone ~= 'fov' then
				local weapon = ply:GetActiveWeapon()

				if IsValid(weapon) and weapon:GetClass():find('octo', 1, false) and (bone == 'Bip01_R_Forearm' or bone == 'Bip01_R_Hand') then continue end -- где find приписку оружия, например у m9k просто m9k

				local id = ply:LookupBone('ValveBiped.' .. bone)
				if not id then continue end
				if data.pos then ply:ManipulateBonePosition(id, data.pos * weight) end
				if data.ang then ply:ManipulateBoneAngles(id, data.ang * weight) end
			end
    	end

        local state = (IsValid(ply:GetVehicle()) and 'sitting') or 'passive'

        if not IsValid(ply.TalkieProp) then
            createTalkieProp(ply)
        elseif ply.lastState ~= state then
            removeTalkieProp(ply)
            ply.lastState = state
            return
		end
    else
        if IsValid(ply.TalkieProp) then removeTalkieProp(ply) end
    end
end)